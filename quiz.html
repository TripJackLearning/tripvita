const SCRIPT_URL = 'YOUR_SCRIPT_URL_HERE';
let questions = [], currentIdx = 0, score = 0, timer, startT, currentCat = "";
let userResponseLog = []; // NEW: Array to track individual question data

async function initQuiz() {
    // ... (keep validation logic) ...
    document.getElementById('reg-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    const resp = await fetch(`${SCRIPT_URL}?action=getQuestions`);
    questions = await resp.json();
    startT = new Date();
    runTimer();
    showStep();
}

function showStep() {
    const q = questions[currentIdx];
    if (q.category !== currentCat) { currentCat = q.category; showSectionOverlay(currentCat); return; }
    
    document.getElementById('quiz-screen').classList.remove('hidden');
    document.getElementById('progress-fill').style.width = `${((currentIdx + 1) / questions.length) * 100}%`;
    document.getElementById('cat-badge').innerText = q.category;
    document.getElementById('q-text').innerText = q.question;
    document.getElementById('expl-box').classList.add('hidden');
    
    const box = document.getElementById('opt-box');
    box.innerHTML = '';
    
    q.options.forEach(o => {
        const b = document.createElement('button');
        b.className = 'opt-btn';
        b.innerText = o;
        b.onclick = () => {
            const isCorrect = (o === q.answer);
            
            // LOG THE DATA FOR GAP ANALYSIS
            userResponseLog.push({
                question: q.question,
                category: q.category,
                userAnswer: o,
                isCorrect: isCorrect
            });

            if(isCorrect) {
                b.classList.add('correct');
                score++;
            } else {
                b.classList.add('wrong');
                Array.from(box.children).find(btn => btn.innerText === q.answer).classList.add('correct');
            }
            Array.from(box.children).forEach(btn => btn.disabled = true);
            document.getElementById('expl-text').innerText = q.explanation;
            document.getElementById('expl-box').classList.remove('hidden');
        };
        box.appendChild(b);
    });
}

async function finish() {
    clearInterval(timer);
    const finalTimeStr = document.getElementById('timer-text').innerText;
    const totalSecs = Math.floor((new Date() - startT) / 1000);
    
    const payload = {
        name: document.getElementById('uName').value,
        email: document.getElementById('uEmail').value,
        region: document.getElementById('uRegion').value,
        score: score,
        timeTakenSeconds: totalSecs,
        timeFormatted: finalTimeStr,
        details: userResponseLog // SENDING THE DETAILED LOG
    };

    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(payload)
    });

    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#EF7F1A', '#1A1A1A'] });

    document.querySelector('.quiz-card').innerHTML = `
        <div class="logo-container"><img src="YOUR_LOGO_URL" class="brand-logo"></div>
        <h2 style="text-align:center">Assessment Complete!</h2>
        <div style="text-align:center; padding: 20px 0;">
            <h1 style="font-size: 72px; margin: 10px 0; color: var(--primary);">${score}/20</h1>
            <p style="font-weight: 700;">Result Recorded</p>
        </div>
        <button class="btn-primary" onclick="location.href='leaderboard.html'">View Leaderboard</button>
    `;
}
